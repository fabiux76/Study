<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Repo - My Studies</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Studies</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../todo/" class="nav-link">Todo</a>
                            </li>
                            <li class="navitem">
                                <a href="../../done/" class="nav-link">Done</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">TypeScript <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Typescript/typescript/" class="dropdown-item">General</a>
</li>
                                    
<li>
    <a href="../../Typescript/usecases/" class="dropdown-item">UseCases</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Serverless <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../liveproject/" class="dropdown-item">Liveproject</a>
</li>
                                    
<li>
    <a href="../typescript%20template/" class="dropdown-item">Typescript Template</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../Github/github_actions/" class="nav-link">Github</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#repo" class="nav-link">Repo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#docker-compose" class="nav-link">docker-compose</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#strumentilibrerie-utilizzate" class="nav-link">strumenti\librerie utilizzate</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#comandi-di-script" class="nav-link">comandi di script</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#tsoa" class="nav-link">tsoa</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#serverless-offline" class="nav-link">serverless-offline</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#layers" class="nav-link">Layers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#serverless-http" class="nav-link">serverless-http</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#aws-secret-manager" class="nav-link">AWS Secret Manager</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#prova" class="nav-link">PROVA</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="repo">Repo</h1>
<p>Faccio riferimento a <a href="https://github.com/besharpsrl/blog-serverless-backend-nodejs">questo repo</a> 
<a href="https://www.proud2becloud.com/it/costruiamo-un-backend-serverless-con-typescript-nodejs-e-aws-lambda/">Qui</a> invece l'articolo in cui lo presentano</p>
<p>Cose interessanti</p>
<h1 id="docker-compose">docker-compose</h1>
<p>docker-compose usato per far partire un'istanza locale di postgres per i test in locale</p>
<h1 id="strumentilibrerie-utilizzate">strumenti\librerie utilizzate</h1>
<ul>
<li><strong>express</strong>. La lamda è in realtà un'istanza di express, quindi la stessa lambda in realtà serve molte rotte, a differenza della soluzione del liveproject in cui ogni lambda era per una rotta separata)</li>
<li><strong>tsoa</strong>. PEr fare documentazione swagger e definire rotte... (?)</li>
<li><strong>sequelize</strong>. Dovrebbe essere un ORM</li>
<li><strong>serverless-offline</strong>. Per fare test in locale</li>
<li><strong>serverless-http</strong>. Questo secondo me è quello che ci fa collegare il mondo lambda al mondo express</li>
<li>uso dei labmda layers</li>
</ul>
<h1 id="comandi-di-script">comandi di script</h1>
<pre><code class="language-json">  &quot;scripts&quot;: {
    &quot;generate-swagger&quot;: &quot;./node_modules/tsoa/dist/cli.js swagger&quot;,
    &quot;generate-routes&quot;: &quot;./node_modules/tsoa/dist/cli.js routes&quot;,
    &quot;build&quot;: &quot;./node_modules/typescript/bin/tsc&quot;,
    &quot;prebuild&quot;: &quot;npm run generate-routes &amp;&amp; ./node_modules/tslint/bin/tslint -c tslint.json -p tsconfig.json --fix &amp;&amp; rm -rf dist/&quot;,
    &quot;prestart&quot;: &quot;npm install &amp;&amp; npm run build&quot;,
    &quot;start&quot;: &quot;isLocal=true NODE_ENV=dev sls offline start&quot;,
    &quot;pre-deploy&quot;: &quot;rm -rf node_modules .serverless &amp;&amp; npm install --production &amp;&amp; npm run build &amp;&amp; ./prepare-layer.sh&quot;,
    &quot;deploy-dev&quot;: &quot;npm run pre-deploy &amp;&amp; NODE_ENV=dev sls deploy&quot;,
    &quot;migrate-db-local&quot;: &quot;NODE_ENV=local ./node_modules/sequelize-cli/lib/sequelize db:migrate&quot;,
    &quot;migrate-db-dev&quot;: &quot;NODE_ENV=dev ./node_modules/sequelize-cli/lib/sequelize db:migrate&quot;
  },
</code></pre>
<p>Interessante:
- il <code>build</code> fa la compilazione del typescript in javascript. Prima però il <code>prebuild fa diverse cose</code>:
    - <code>./node_modules/tsoa/dist/cli.js routes</code>
    - <code>./node_modules/tslint/bin/tslint -c tslint.json -p tsconfig.json --fix</code>
    - <code>rm -rf dist/</code>
- lo <code>start</code> e <code>prestart</code> servono per fare il deploy in locale. 
    - installazione dei pacchetti: <code>npm install</code>
    - step di build: <code>npm run build</code>
    - start del plugin sls offline: <code>isLocal=true NODE_ENV=dev sls offline start</code>
- il <code>pre-deploy</code> e <code>deploy-dev</code> fanno invece il deploy su ambiente dev. Fondamente fanno:
    - clean = <code>rm -rf node_modules .serverless</code>  <br />
    - installazione dei pacchetti di produzione = <code>npm install --production</code>
    - step di build: <code>npm run build</code>
    - Preparazione del layer: <code>./prepare-layer.sh</code>
    - deploy vero e proprio serverless: <code>NODE_ENV=dev sls deploy</code></p>
<p>Quindi secondo me, per fare il deploy.
In locale:
- <code>docker-compose up</code>
- <code>npm run migrate-db-local</code>
- <code>npm run start</code></p>
<p>PEr depolyare su ambiente dev:
- <code>npm run deploy-dev</code>
Poi però devo fare 
- <code>npm run migrate-db-dev</code> da una macchina (Bastion host??? ma non ho cpaito come può funzionare... , sul bastion host mica c'è quel codice...)</p>
<h1 id="tsoa">tsoa</h1>
<p><strong>tsoa</strong>, ovvero <em>OpenAPI-compliant REST APIs using TypeScript and Node</em> è <a href="https://tsoa-community.github.io/docs/">qui</a></p>
<p>tsoa is a framework with integrated OpenAPI compiler to build Node.js serve-side applications using TypeScript. It can target express, hapi, koa and more frameworks at runtime. tsoa applications are type-safe by default and handle runtime validation seamlessly</p>
<p>Fondamentalmente possiamo interpretare questo progetto di besharp come:
- progetto di rest <strong>tsoa</strong> basato su <strong>express</strong>
- che per lo storage dei dati usa <strong>postgress</strong> attraverso la libreria <strong>sequelize</strong>
- invece che essere esposto come server a se stante usa <strong>serverless</strong> per essere deployato come lambda, e <strong>serverless-http</strong> come strumento per linkare il modello di invocazione delle lambda a quello di express
- usa <strong>serverless-offline</strong> per permettere di fare i test in locale </p>
<p>Nel progetto vengono usati questi due comandi rispettivamente per la generazione della codumentazione swagger ed il codice delle rotte:</p>
<pre><code>&quot;generate-swagger&quot;: &quot;./node_modules/tsoa/dist/cli.js swagger&quot;,
&quot;generate-routes&quot;: &quot;./node_modules/tsoa/dist/cli.js routes&quot;,
</code></pre>
<p>Mentre nella <a href="https://tsoa-community.github.io/docs/generating.html#using-cli">documentazione</a> di tsoa vengono usati questi:</p>
<pre><code># generate OAS
tsoa spec

# generate routes
tsoa routes
</code></pre>
<p>Forse loro usavano una versione un po' vecchia</p>
<p>Approfondisco questo tema molto interessante <a href="../../Typescript/tsoa/">qui</a></p>
<h1 id="serverless-offline">serverless-offline</h1>
<p>Qui il <a href="https://www.serverless.com/plugins/serverless-offline">link</a>. È un plugin.</p>
<p>This Serverless plugin emulates AWS λ and API Gateway on your local machine to speed up your development cycles. To do so, it starts an HTTP server that handles the request's lifecycle like APIG does and invokes your handlers.</p>
<p>Approfondisco <a href="../serverless-offline/">qui</a></p>
<h1 id="layers">Layers</h1>
<p>Usano questo approccio</p>
<pre><code class="language-yml">package:
  exclude:
    - node_modules/**
    - src/**

layers:
  nodeModules:
    path: layer
    compatibleRuntimes:
      - nodejs12.x
</code></pre>
<p>Cioè tutte le dipendenze node le sposta nella directory <code>layer</code>.... Ma questo secondo me non è il corretto uso</p>
<p><code>prepare-layer.sh</code> fa questo:</p>
<pre><code>mkdir -p layer/nodejs
cp -r ./node_modules ./layer/nodejs
cp package.json ./layer/nodejs
</code></pre>
<p>NElla docuemntazione scrivono:
Con questa configurazione, infatti, andremo a creare un Lambda Layer contenente tutti i node modules. Così facendo, alleggeriremo notevolmente le dimensioni della nostra funzione ottenendo vantaggi in performance durante la sua esecuzione.</p>
<p>Quindi comq forse ha senso valutare... Sicoome è stta fatta una lambda con express forse effettivamente è un po' ciccia</p>
<h1 id="serverless-http">serverless-http</h1>
<p><a href="https://www.npmjs.com/package/serverless-http">This module</a> allows you to 'wrap' your API for serverless use. No HTTP server, no ports or sockets. Just your code in the same execution pipeline you are already familiar with.</p>
<h1 id="aws-secret-manager">AWS Secret Manager</h1>
<p>Usa secret manager pee recuperare le credenziali di accesso al DB</p>
<h1 id="prova">PROVA</h1>
<p>PRovo a vedere se effettivamente funziona e cosa bisogna cambiare
Steps:
1 <code>npm install</code>
2 <code>npm run build</code> fallisce su pc per discorso di percorsi, ma funziona su mac. Continuo le prove su mac
3 <code>docker-compose up</code>
4 <code>npm run migrate-db-local</code>
5 <code>npm run start</code> (che poi in realtà i primi 2 step)</p>
<p>E funziona. Riesco a fare la chiamata con postman in locale !
(verificare se riesco anche a fare il debug locale!!!!)</p>
<p>6 <code>npm run deploy-dev</code>. 
Cioè, provo fare deploy su aws. Fa effettivamente un sacco di pasaggi come il caricamento dei zip sia per lambda che per i layer, ma poi fallisce perchè nel file yaml è specificato vpc esplicito
Dopo aver corretto vpc e subnet, mettendo quelle del mio account sono effettivamente riuscito a fare il deploy. <a href="https://eu-west-1.console.aws.amazon.com/lambda/home?region=eu-west-1#/functions/express-serverless-dev-app?tab=code">Qui</a> i dettagli della lambda deployata.
Effettivamente c'è un layer, doe sono i node_modules (che non sono nl codice della lambda)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
